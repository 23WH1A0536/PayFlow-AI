# PayFlow Automatic Payroll Scheduler

## Overview
This document explains the automatic payroll generation system implemented for PayFlow.

## Components Added

### 1. PayrollScheduler.java
**Location**: `src/main/java/com/payflowapi/scheduler/PayrollScheduler.java`

**Features**:
- **Automatic Monthly Generation**: Runs at 11:59 PM on the last day of each month
- **Missed Payroll Check**: Runs at 12:05 AM on the 1st of each month to catch any missed generations
- **Comprehensive Logging**: Detailed logging for monitoring and debugging

**Cron Expressions**:
- Main scheduler: `"0 59 23 L * ?"` (11:59 PM on last day of month)
- Missed payroll check: `"0 5 0 1 * ?"` (12:05 AM on 1st of month)

### 2. PayflowApiApplication.java (Modified)
**Added**: `@EnableScheduling` annotation to enable Spring's scheduled task execution

### 3. SchedulingConfig.java
**Location**: `src/main/java/com/payflowapi/config/SchedulingConfig.java`

**Purpose**: Configures dedicated thread pool for scheduled tasks to ensure they don't interfere with web requests

### 4. PayrollSchedulerController.java
**Location**: `src/main/java/com/payflowapi/controller/PayrollSchedulerController.java`

**Endpoints**:
- `POST /api/payroll/scheduler/generate-current-month` - Manually generate current month payroll
- `POST /api/payroll/scheduler/generate-specific` - Generate payroll for specific month/year
- `GET /api/payroll/scheduler/status` - Get scheduler status and configuration

## How It Works

### Automatic Generation Process
1. **Trigger**: At 11:59 PM on the last day of each month
2. **Action**: Calls `PayslipService.generateBulkPayslips()` for all eligible employees
3. **Generated By**: Marked as "SYSTEM_AUTO_SCHEDULER"
4. **Logging**: Records success/failure and number of payslips generated

### Missed Payroll Recovery
1. **Trigger**: At 12:05 AM on the 1st of each month
2. **Check**: Looks for payslips from the previous month
3. **Action**: If no payslips found, generates them automatically
4. **Generated By**: Marked as "SYSTEM_MISSED_PAYROLL"

### Error Handling
- All exceptions are caught and logged
- System continues running even if one month fails
- Detailed error messages in logs for troubleshooting

## Integration with Existing System

### No Breaking Changes
- Uses existing `PayslipService.generateBulkPayslips()` method
- Maintains all current functionality
- No changes to database schema required

### Leverages Existing Logic
- Uses same calculation logic as manual generation
- Respects existing business rules (employee eligibility, CTC requirements)
- Generates payslips in same format as manual process

## Manual Control

### HR Dashboard Integration
HR users can still:
- Generate payrolls manually using existing UI
- View generated payslips
- Download payslips
- Monitor payroll status

### Manual Override
- Use REST endpoints to manually trigger generation
- Generate for specific months if needed
- Check scheduler status

## Monitoring and Logs

### Log Levels
- **INFO**: Normal operations, generation counts
- **WARN**: Missed payrolls detected
- **ERROR**: Generation failures
- **DEBUG**: Detailed per-payslip information

### Log Examples
```
INFO: Starting automatic payroll generation for August 2025
INFO: Successfully generated 45 payslips automatically for August 2025
WARN: No payslips found for July 2025, generating missed payroll
ERROR: Failed to generate automatic payroll: Database connection failed
```

## Testing

### Test Scheduler (Optional)
- Uncomment the `@Scheduled` annotation on `testScheduler()` method
- Runs every minute for testing purposes
- **Remember to comment out in production**

### Manual Testing
- Use the REST endpoints to test generation
- Check logs for proper execution
- Verify payslips are created correctly

## Production Deployment

### Configuration
- Scheduler is enabled automatically when application starts
- No additional configuration required
- Uses Spring Boot's default scheduling configuration

### Monitoring
- Check application logs for scheduler execution
- Monitor database for newly generated payslips
- Set up alerts for ERROR level logs

## Security

### Authentication
- Manual trigger endpoints should be protected (implement as needed)
- Only HR/Admin users should access manual controls
- Scheduler runs with system privileges

### Error Handling
- Graceful failure handling prevents system crashes
- Detailed logging for audit trails
- Continues operation even if some employees fail

## Future Enhancements

### Possible Additions
1. Email notifications when payroll is generated
2. Slack/Teams integration for notifications
3. Custom scheduling configuration via properties
4. Retry mechanism for failed generations
5. Dashboard widget showing scheduler status

### Configuration Options
Consider adding application properties for:
- Custom cron expressions
- Enable/disable scheduler
- Retry attempts
- Email notifications

## Troubleshooting

### Common Issues
1. **Scheduler not running**: Check `@EnableScheduling` annotation
2. **No payslips generated**: Check employee eligibility and CTC data
3. **Performance issues**: Monitor thread pool configuration
4. **Time zone issues**: Verify server timezone settings

### Log Analysis
- Search for "PayrollScheduler" in logs
- Check for ERROR level messages
- Monitor generation counts vs expected employee count
